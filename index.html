<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/splide.min.css">
    <meta charset="UTF-8">
    <title>Países donde se habla español</title>
    <script src="js/d3.v3.min.js" type="text/javascript"></script>
    <script src="js/topojson.v1.min.js" type="text/javascript"></script>
    <script src="js/datamaps.world.min.js" type="text/javascript"></script>
    <script src="js/jquery-2.2.3.min.js" type="text/javascript"></script>
    <script src="data/data.js" type="text/javascript"></script>
    <script src="js/splide.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        if (!('IntersectionObserver' in window)) {
            const script = document.createElement("script");
            script.src = "https://raw.githubusercontent.com/w3c/IntersectionObserver/master/polyfill/intersection-observer.js";
            document.getElementsByTagName('head')[0].appendChild(script);
        }
    </script>
    <script src="js/lozad.min.js" type="text/javascript"></script>
</head>
<body>


<div style="width: 100%">
    <h1 class="center-text">Länder, in denen Spanisch gesprochen wird | Países donde se habla español</h1>
</div>
<div id="box" style="flex: 1; overflow: hidden">
    <div id="card" class="column"
         style=" width: 60vw; height: 90vh; margin-left: auto; margin-right: auto;">
        <div id="container" class="center"></div>
    </div>
</div>
<div>
    <h3 id="content" class="center-text"></h3>
</div>

<!-- The Modal -->
<div class="modal" id="imageModal">
    <span class="close">&times;</span>
    <img class="modal-content" id="imgModal">
</div>

<script>
    const isos = ["ARG", "BOL", "CHL", "COL", "CRI", "CUB", "DOM", "ECU", "SLV", "GTM", "HND", "MEX", "NIC", "PAN", "PRY", "PER", "PRI", "URY", "VEN", "ESP", "BLZ", "BRA", "USA", "DEU"];
    const fills = {
        defaultFill: "#374140",
        highlighted: "#FF3B30",
        second: "#FF9500"
    };

    window.onload = function () {
        var mobile = (/iphone|ipad|ipod|android|blackberry|mini|windows\sce|palm/i.test(navigator.userAgent.toLowerCase()));
        if (mobile) {
            alert("Besuche diese Seite auf einem Computer für eine bessere Anzeige");
        } else {

        }
    };

    function Zoom(args) {
        $.extend(this, {
            $info: $("#zoom-info"),
            scale: {max: 50, currentShift: 0},
            $container: args.$container,
            datamap: args.datamap
        });

        this.init();
    }

    Zoom.prototype.init = function () {
        var paths = this.datamap.svg.selectAll("path"),
            subunits = this.datamap.svg.selectAll(".datamaps-subunit");

        // preserve stroke thickness
        // paths.style("vector-effect", "non-scaling-stroke");

        // disable click on drag end
        subunits.call(
            d3.behavior.drag().on("dragend", function () {
                d3.event.sourceEvent.stopPropagation();
            })
        );

        this.scale.set = this._getScalesArray();
        this.d3Zoom = d3.behavior.zoom().scaleExtent([1, this.scale.max]);

        this._displayPercentage(1);
        this.listen();
    };

    Zoom.prototype.listen = function () {
        this.datamap.svg
            .call(this.d3Zoom.on("zoom", this._handleScroll.bind(this)))
            .on("dblclick.zoom", null); // disable zoom on double-click
    };

    Zoom.prototype.reset = function () {
        this._shift("reset");
    };

    Zoom.prototype._handleScroll = function () {
        var translate = d3.event.translate,
            scale = d3.event.scale,
            limited = this._bound(translate, scale);

        this.scrolled = true;

        this._update(limited.translate, limited.scale);
    };

    Zoom.prototype._shift = function (direction) {
        var center = [this.$container.width() / 2, this.$container.height() / 2],
            translate = this.d3Zoom.translate(), translate0 = [], l = [],
            view = {
                x: translate[0],
                y: translate[1],
                k: this.d3Zoom.scale()
            }, bounded;

        translate0 = [
            (center[0] - view.x) / view.k,
            (center[1] - view.y) / view.k
        ];

        if (direction == "reset") {
            view.k = 1;
            this.scrolled = true;
        } else {
            view.k = this._getNextScale(direction);
        }

        l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y];

        view.x += center[0] - l[0];
        view.y += center[1] - l[1];

        bounded = this._bound([view.x, view.y], view.k);

        this._animate(bounded.translate, bounded.scale);
    };

    Zoom.prototype._bound = function (translate, scale) {
        var width = this.$container.width(),
            height = this.$container.height();

        translate[0] = Math.min(
            (width / height) * (scale - 1),
            Math.max(width * (1 - scale), translate[0])
        );

        translate[1] = Math.min(0, Math.max(height * (1 - scale), translate[1]));

        return {translate: translate, scale: scale};
    };

    Zoom.prototype._update = function (translate, scale) {
        this.d3Zoom
            .translate(translate)
            .scale(scale);

        this.datamap.svg.selectAll("g")
            .attr("transform", "translate(" + translate + ")scale(" + scale + ")");

        this._displayPercentage(scale);
    };

    Zoom.prototype._animate = function (translate, scale) {
        var _this = this,
            d3Zoom = this.d3Zoom;

        d3.transition().duration(350).tween("zoom", function () {
            var iTranslate = d3.interpolate(d3Zoom.translate(), translate),
                iScale = d3.interpolate(d3Zoom.scale(), scale);

            return function (t) {
                _this._update(iTranslate(t), iScale(t));
            };
        });
    };

    Zoom.prototype._displayPercentage = function (scale) {
        var value;

        value = Math.round(Math.log(scale) / Math.log(this.scale.max) * 100);
        this.$info.text(value + "%");
    };

    Zoom.prototype._getScalesArray = function () {
        var array = [],
            scaleMaxLog = Math.log(this.scale.max);

        for (var i = 0; i <= 10; i++) {
            array.push(Math.pow(Math.E, 0.1 * i * scaleMaxLog));
        }

        return array;
    };

    Zoom.prototype._getNextScale = function (direction) {
        var scaleSet = this.scale.set,
            currentScale = this.d3Zoom.scale(),
            lastShift = scaleSet.length - 1,
            shift, temp = [];

        if (this.scrolled) {

            for (shift = 0; shift <= lastShift; shift++) {
                temp.push(Math.abs(scaleSet[shift] - currentScale));
            }

            shift = temp.indexOf(Math.min.apply(null, temp));

            if (currentScale >= scaleSet[shift] && shift < lastShift) {
                shift++;
            }

            if (direction == "out" && shift > 0) {
                shift--;
            }

            this.scrolled = false;

        } else {

            shift = this.scale.currentShift;

            if (direction == "out") {
                shift > 0 && shift--;
            } else {
                shift < lastShift && shift++;
            }
        }

        this.scale.currentShift = shift;

        return scaleSet[shift];
    };

    function Datamap() {
        this.$container = $("#container");
        new Datamaps({
            scope: 'world',
            element: this.$container.get(0),
            projection: 'mercator',
            dataUrl: 'data/data.json',
            dataType: 'json',
            data: {},
            fills: fills,
            done: this._handleMapReady.bind(this),
            geographyConfig: {
                highlightOnHover: true,
                highlightFillColor: function (geography) {
                    return hex2rgba(geography['fillKey'] ? fills[geography['fillKey']] : undefined, .5) || "#374140";
                },
                highlightBorderColor: 'fff',
                highlightBorderWidth: 1,
                popupTemplate: function (geography, data) {
                    if (isos.includes(geography.id)) {
                        return '<div class="hoverinfo">' + jsonData[geography.id]["Name"] + '</div>';
                    } else {
                        return undefined
                    }
                },
            },
        });
    }

    const hex2rgba = (hex, alpha = 1) => {
        if (hex !== undefined) {
            const [r, g, b] = hex.match(/\w\w/g).map(x => parseInt(x, 16));
            return `rgba(${r},${g},${b},${alpha})`;
        }
    };

    const observer = lozad();

    const modal = document.getElementById("imageModal");
    const span = document.getElementsByClassName("close")[0];

    Datamap.prototype._handleMapReady = function (datamap) {
        datamap.svg.selectAll('.datamaps-subunit').on('click', function (geography) {

            if (isos.includes(geography.id)) {
                let name = jsonData[geography.id]["Name"];
                if (jsonData[geography.id]["Name"].indexOf(',') > -1) {
                    const str = jsonData[geography.id]["Name"](',');
                    name = str[1] + " " + str[0]
                }
                if ($("#box #info").length > 0) {
                    $('#country-info').html(getInfo(name, geography.id));
                    observer.observe();
                    if (Array.isArray(jsonData[geography.id]["Image"])) {
                        const splide = new Splide('#image-slider', {
                            'type': 'loop',
                            'autoplay': true,
                            'lazyLoad': "nearby",
                        }).mount();

                        splide.on("click", (slide) => {
                            modal.style.display = "block";
                            document.getElementById("imgModal").src = slide.slide.firstChild.dataset["splideLazy"];
                        });
                        span.onclick = function () {
                            modal.style.display = "none";
                        }
                    }

                } else {
                    $('#box').append(`<div id='info' class="column" style=" width: 33vw; float: left; will-change: transform;"><div id='country-info' >${getInfo(name, geography.id)}</div></div>`);
                    $('#card').css({"float": "left"});
                    observer.observe();
                    if (Array.isArray(jsonData[geography.id]["Image"])) {
                        const splide = new Splide('#image-slider', {
                            'type': 'loop',
                            'autoplay': true,
                            'lazyLoad': "nearby",
                        }).mount();

                        splide.on("click", (slide) => {
                            modal.style.display = "block";
                            document.getElementById("imgModal").src = slide.slide.firstChild.dataset["splideLazy"];
                        });
                        span.onclick = function () {
                            modal.style.display = "none";
                        }
                    }
                }
                observer.observe();
            } else {
                $('#info').remove();
                $('#card').css("float", "")
            }
        });

        this.zoom = new Zoom({
            $container: this.$container,
            datamap: datamap
        });
    };


    function getInfo(country, id) {
        const name = jsonData[id]["Name"];
        const flag = jsonData[id]["Country_flag"].split("_")[1];
        const audio = jsonData[id]["Audio"];
        const transcript = jsonData[id]["Transcript"];
        const images = jsonData[id]["Image"];
        const languages = jsonData[id]["languages"];
        const culture = jsonData[id]["culture"];
        const famous = jsonData[id]["Famous_people"];
        const video = jsonData[id]["Video"];

        const videoPlayer = video && Array.isArray(video) ? getVideos(video) : "";
        const audioPlayer = audio ? `<h3>Dialekt</h3><audio class="center-text" controls style="width: 90%; "> <source src="./data/dialectAudio/${audio}" type="audio/${audio.split(".").slice(-1)[0]}"></audio>${transcript ? "<h3>Transkript</h3>" : ""}${transcript} <br>` : "";
        const languagesInfo = languages ? `<h3>Sprache</h3> ${languages} <br>` : "";
        const culureInfo = culture ? `<h3>Kultur</h3> ${culture} <br>` : "";
        const famousInfo = famous ? `<h3>Bekannte Persönlichkeiten</h3> ${famous} <br>` : "";
        const imageGallery = images && Array.isArray(images) ? `<br><br><div id="image-slider" class="splide center-text"> <div class="splide__track"><ul class="splide__list">${getImages(images)}</ul></div> <div class="splide__progress"><div class="splide__progress__bar"></div></div></div><br><br>` : "";
        return (`<h1 class='center-text'>${name}</h1> <img class='center-text lozad' data-src="./data/Flag/${flag}.jpg" alt="${name} Flagge" style="margin-bottom: 16px;margin-top: 16px;height: 50%; width: 50%; object-fit: contain" /> <br> ${audioPlayer}  ${languagesInfo} ${culureInfo}  ${famousInfo} ${imageGallery}   ${videoPlayer}`);
    }

    function getImages(images) {
        let imageString = "";
        if (Array.isArray(images)) {
            images.forEach((item) => {
                imageString += `<li class="splide__slide" ><img data-splide-lazy="./data/Image/${item}" alt="${item}" ></li>`

            })
        }
        return imageString
    }

    function getVideos(videos) {
        let videoString = "";
        if (Array.isArray(videos)) {
            videos.forEach((item) => {
                if (item[1].includes("https://you")) {
                    const x = item[1].split("/");
                    const embeded_link = `https://www.youtube.com/embed/${x[x.length - 1]}`;
                    videoString += `<h3 class="center-text">${item[0]}</h3> <div class="resp-container"> <iframe class='center-text resp-iframe lozad' width="533.33" height="300" data-src="${embeded_link}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><br>`
                } else {
                    videoString += `<h3 class="center-text">${item[0]}</h3><div class="resp-container"><video controls class="lozad resp-iframe center-text"> <source data-src="./data/Image/${item[1]}" ></video></div>`
                }
            })
        }
        return videoString
    }


    new Datamap();
</script>
</body>
</html>