function Zoom(t){$.extend(this,{$info:$("#zoom-info"),scale:{max:50,currentShift:0},$container:t.$container,datamap:t.datamap}),this.init()}Zoom.prototype.init=function(){this.datamap.svg.selectAll("path");this.datamap.svg.selectAll(".datamaps-subunit").call(d3.behavior.drag().on("dragend",function(){d3.event.sourceEvent.stopPropagation()})),this.scale.set=this._getScalesArray(),this.d3Zoom=d3.behavior.zoom().scaleExtent([1,this.scale.max]),this._displayPercentage(1),this.listen()},Zoom.prototype.listen=function(){this.datamap.svg.call(this.d3Zoom.on("zoom",this._handleScroll.bind(this))).on("dblclick.zoom",null)},Zoom.prototype.reset=function(){this._shift("reset")},Zoom.prototype._handleScroll=function(){var t=d3.event.translate,o=d3.event.scale,a=this._bound(t,o);this.scrolled=!0,this._update(a.translate,a.scale)},Zoom.prototype._shift=function(t){var o,a,e,s=[this.$container.width()/2,this.$container.height()/2],i=this.d3Zoom.translate(),n={x:i[0],y:i[1],k:this.d3Zoom.scale()};o=[(s[0]-n.x)/n.k,(s[1]-n.y)/n.k],"reset"==t?(n.k=1,this.scrolled=!0):n.k=this._getNextScale(t),a=[o[0]*n.k+n.x,o[1]*n.k+n.y],n.x+=s[0]-a[0],n.y+=s[1]-a[1],e=this._bound([n.x,n.y],n.k),this._animate(e.translate,e.scale)},Zoom.prototype._bound=function(t,o){var a=this.$container.width(),e=this.$container.height();return t[0]=Math.min(a/e*(o-1),Math.max(a*(1-o),t[0])),t[1]=Math.min(0,Math.max(e*(1-o),t[1])),{translate:t,scale:o}},Zoom.prototype._update=function(t,o){this.d3Zoom.translate(t).scale(o),this.datamap.svg.selectAll("g").attr("transform","translate("+t+")scale("+o+")"),this._displayPercentage(o)},Zoom.prototype._animate=function(t,o){var a=this,e=this.d3Zoom;d3.transition().duration(350).tween("zoom",function(){var s=d3.interpolate(e.translate(),t),i=d3.interpolate(e.scale(),o);return function(t){a._update(s(t),i(t))}})},Zoom.prototype._displayPercentage=function(t){var o;o=Math.round(Math.log(t)/Math.log(this.scale.max)*100),this.$info.text(o+"%")},Zoom.prototype._getScalesArray=function(){for(var t=[],o=Math.log(this.scale.max),a=0;a<=10;a++)t.push(Math.pow(Math.E,.1*a*o));return t},Zoom.prototype._getNextScale=function(t){var o,a=this.scale.set,e=this.d3Zoom.scale(),s=a.length-1,i=[];if(this.scrolled){for(o=0;o<=s;o++)i.push(Math.abs(a[o]-e));e>=a[o=i.indexOf(Math.min.apply(null,i))]&&o<s&&o++,"out"==t&&o>0&&o--,this.scrolled=!1}else o=this.scale.currentShift,"out"==t?o>0&&o--:o<s&&o++;return this.scale.currentShift=o,a[o]};